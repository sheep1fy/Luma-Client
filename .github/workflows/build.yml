name: Build Luma Client

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-x86_64:
    name: Build x86_64
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: ðŸ”§ Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential git
    
    - name: ðŸ“¦ Setup Android NDK r26b
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true
    
    - name: ðŸ” Verify NDK
      run: |
        echo "NDK: ${{ steps.setup-ndk.outputs.ndk-path }}"
        echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
    
    - name: ðŸ’¾ Cache Dobby
      id: cache-dobby
      uses: actions/cache@v4
      with:
        path: /tmp/dobby-install
        key: dobby-x86_64-r26b-patched-v4
    
    - name: ðŸª Clone and Patch Dobby for x86_64
      if: steps.cache-dobby.outputs.cache-hit != 'true'
      run: |
        # Clone Dobby
        git clone --depth 1 https://github.com/jmpews/Dobby.git /tmp/dobby-src
        cd /tmp/dobby-src
        
        # Patch CMakeLists.txt to exclude ARM64 assembly for x86_64 builds
        cat >> source/TrampolineBridge/ClosureTrampolineBridge/CMakeLists.txt << 'EOF'
        
        # Exclude ARM64 assembly when building for x86_64
        if(PROCESSOR MATCHES "x86_64")
          list(REMOVE_ITEM closure_trampoline_files
            ${CMAKE_CURRENT_SOURCE_DIR}/arm64/closure_bridge_arm64.asm
            ${CMAKE_CURRENT_SOURCE_DIR}/arm64/closure_trampoline_arm64.asm
          )
          message(STATUS "Excluded ARM64 assembly files for x86_64 build")
        endif()
        EOF
        
        echo "âœ… Dobby patched for x86_64"
    
    - name: ðŸ”¨ Build Dobby for x86_64
      if: steps.cache-dobby.outputs.cache-hit != 'true'
      run: |
        mkdir -p /tmp/dobby-build
        cd /tmp/dobby-build
        
        # Configure
        cmake /tmp/dobby-src \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=x86_64 \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/tmp/dobby-install \
          -DDOBBY_DEBUG=OFF \
          -DPlugin.SymbolResolver=ON
        
        # Build
        ninja -j$(nproc)
        
        # Install
        ninja install
        
        echo "âœ… Dobby built and installed"
        ls -la /tmp/dobby-install/lib/
    
    - name: ðŸ“‹ Verify Project Files
      run: |
        echo "=== CMakeLists.txt ==="
        head -30 CMakeLists.txt
        
        echo ""
        echo "=== ImGui Files ==="
        ls -la imgui/ 2>/dev/null || echo "âš  imgui/ not found"
        
        echo ""
        echo "=== Source Files ==="
        ls -la src/
    
    - name: âš™ï¸ Configure Luma Client
      run: |
        mkdir -p build
        cd build
        
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=x86_64 \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH="/tmp/dobby-install" \
          -DCMAKE_FIND_ROOT_PATH="/tmp/dobby-install"
    
    - name: ðŸ”¨ Build Luma Client
      run: |
        cd build
        ninja -v -j$(nproc)
    
    - name: âœ… Verify Build
      run: |
        if [ ! -f "build/libluma_client.so" ]; then
          echo "âŒ Build failed"
          find build -name "*.so" || echo "No .so files"
          exit 1
        fi
        
        echo "âœ… Build successful!"
        echo "Size: $(du -h build/libluma_client.so | cut -f1)"
        file build/libluma_client.so
        nm -D build/libluma_client.so | grep -E "init_luma|toggle_luma|run_luma"
    
    - name: ðŸ—œï¸ Strip Binary
      run: |
        ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip build/libluma_client.so
        echo "Final size: $(du -h build/libluma_client.so | cut -f1)"
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: luma-client-x86_64
        path: build/libluma_client.so
        retention-days: 30

  build-arm64:
    name: Build ARM64
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: ðŸ”§ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential git
    
    - name: ðŸ“¦ Setup NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true
    
    - name: ðŸ’¾ Cache Dobby
      id: cache-dobby
      uses: actions/cache@v4
      with:
        path: /tmp/dobby-install
        key: dobby-arm64-r26b-v4
    
    - name: ðŸª Build Dobby for ARM64
      if: steps.cache-dobby.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 https://github.com/jmpews/Dobby.git /tmp/dobby-src
        mkdir -p /tmp/dobby-build
        cd /tmp/dobby-build
        
        cmake /tmp/dobby-src \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/tmp/dobby-install \
          -DDOBBY_DEBUG=OFF
        
        ninja -j$(nproc)
        ninja install
    
    - name: âš™ï¸ Configure
      run: |
        mkdir -p build
        cd build
        
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH="/tmp/dobby-install"
    
    - name: ðŸ”¨ Build
      run: |
        cd build
        ninja -j$(nproc)
    
    - name: âœ… Verify
      run: |
        if [ ! -f "build/libluma_client.so" ]; then
          echo "âŒ ARM64 build failed"
          exit 1
        fi
        echo "âœ… ARM64 build successful"
        file build/libluma_client.so
    
    - name: ðŸ—œï¸ Strip
      run: |
        ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip build/libluma_client.so
    
    - name: ðŸ“¤ Upload
      uses: actions/upload-artifact@v4
      with:
        name: luma-client-arm64
        path: build/libluma_client.so
        retention-days: 30

  release:
    name: Create Release
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ“¥ Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: ðŸ“¦ Prepare Release
      run: |
        mkdir release
        cp artifacts/luma-client-x86_64/libluma_client.so release/luma-client-x86_64.so
        cp artifacts/luma-client-arm64/libluma_client.so release/luma-client-arm64.so
        
        cd release
        sha256sum luma-client-x86_64.so > checksums.txt
        sha256sum luma-client-arm64.so >> checksums.txt
        
        cat > INSTALL.md << 'EOF'
        # Installation
        
        ## Linux (mcpelauncher)
        ```bash
        wget https://github.com/sheep1fy/Luma-Client/releases/latest/download/luma-client-x86_64.so
        mv luma-client-x86_64.so ~/.local/share/mcpelauncher/mods/libluma_client.so
        ```
        
        Press **K** in-game to open menu.
        EOF
        
        ls -lh
    
    - name: ðŸš€ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/luma-client-x86_64.so
          release/luma-client-arm64.so
          release/checksums.txt
          release/INSTALL.md
        body: |
          ## Luma Client ${{ github.ref_name }}
          
          ### Quick Install
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/luma-client-x86_64.so
          mv luma-client-x86_64.so ~/.local/share/mcpelauncher/mods/libluma_client.so
          ```
          
          Press **K** to open menu.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
