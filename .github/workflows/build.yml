name: Build Luma Client

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-x86_64:
    name: Build x86_64
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: ðŸ”§ Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential git
    
    - name: ðŸ“¦ Setup Android NDK r26b
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true
    
    - name: ðŸ” Verify NDK
      run: |
        echo "NDK: ${{ steps.setup-ndk.outputs.ndk-path }}"
        echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
    
    - name: ðŸ’¾ Cache Dobby
      id: cache-dobby
      uses: actions/cache@v4
      with:
        path: /tmp/dobby-install
        key: dobby-x86_64-r26b-v3
    
    - name: ðŸª Build Dobby for x86_64
      if: steps.cache-dobby.outputs.cache-hit != 'true'
      run: |
        # Clone Dobby
        git clone --depth 1 https://github.com/jmpews/Dobby.git /tmp/dobby-src
        
        # Create build directory
        mkdir -p /tmp/dobby-build
        cd /tmp/dobby-build
        
        # Configure Dobby for x86_64 ONLY
        # CRITICAL: We must set the correct target architecture
        cmake /tmp/dobby-src \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=x86_64 \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/tmp/dobby-install \
          -DDOBBY_DEBUG=OFF \
          -DDOBBY_GENERATE_SHARED=ON \
          -DPlugin.SymbolResolver=ON \
          -DPlugin.Android.BionicLinkerRestriction=ON
        
        # Build
        ninja -j$(nproc)
        
        # Install to /tmp/dobby-install
        ninja install
        
        # Verify
        echo "=== Dobby Build Complete ==="
        ls -la /tmp/dobby-install/
        find /tmp/dobby-install -name "*.so" -o -name "*.a"
    
    - name: ðŸ“‹ Verify Project Files
      run: |
        echo "=== Project Structure ==="
        ls -la
        
        echo ""
        echo "=== ImGui Files ==="
        ls -la imgui/ 2>/dev/null || echo "âš  imgui/ not found"
        
        echo ""
        echo "=== ImGui Backends ==="
        ls -la imgui/backends/ 2>/dev/null || echo "âš  imgui/backends/ not found"
        
        echo ""
        echo "=== Source Files ==="
        ls -la src/
        
        echo ""
        echo "=== CMakeLists.txt Preview ==="
        head -50 CMakeLists.txt
    
    - name: âš™ï¸ Configure Luma Client
      run: |
        mkdir -p build
        cd build
        
        # Configure with proper paths to Dobby
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=x86_64 \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_FIND_ROOT_PATH="/tmp/dobby-install" \
          -DCMAKE_PREFIX_PATH="/tmp/dobby-install" \
          -DCMAKE_VERBOSE_MAKEFILE=ON
    
    - name: ðŸ” Debug CMake Failure
      if: failure()
      run: |
        echo "=== CMake Failed ==="
        echo ""
        echo "=== CMake Cache ==="
        cat build/CMakeCache.txt 2>/dev/null || echo "No cache"
        
        echo ""
        echo "=== CMake Error Log ==="
        cat build/CMakeFiles/CMakeError.log 2>/dev/null || echo "No error log"
        
        echo ""
        echo "=== CMake Output Log ==="
        cat build/CMakeFiles/CMakeOutput.log 2>/dev/null || echo "No output log"
        
        echo ""
        echo "=== Available Dobby Files ==="
        find /tmp/dobby-install -type f 2>/dev/null || echo "Dobby install not found"
    
    - name: ðŸ”¨ Build Luma Client
      run: |
        cd build
        ninja -v -j$(nproc)
    
    - name: ðŸ” Debug Build Failure
      if: failure()
      run: |
        echo "=== Build Failed ==="
        echo ""
        echo "=== Build Directory ==="
        ls -la build/ 2>/dev/null || echo "Build dir not found"
        
        echo ""
        echo "=== Last 50 lines of build output ==="
        tail -n 50 build/.ninja_log 2>/dev/null || echo "No ninja log"
        
        echo ""
        echo "=== Check for output file ==="
        find build -name "*.so" 2>/dev/null || echo "No .so files found"
    
    - name: âœ… Verify Build Output
      run: |
        if [ ! -f "build/libluma_client.so" ]; then
          echo "âŒ ERROR: libluma_client.so not found!"
          echo ""
          echo "Build directory contents:"
          find build -type f
          exit 1
        fi
        
        echo "âœ… Build Successful!"
        echo ""
        echo "File: build/libluma_client.so"
        echo "Size: $(du -h build/libluma_client.so | cut -f1)"
        
        echo ""
        echo "=== File Type ==="
        file build/libluma_client.so
        
        echo ""
        echo "=== Symbols ==="
        nm -D build/libluma_client.so | grep -E "init_luma|toggle_luma|run_luma" || echo "âš  Expected symbols not found"
        
        echo ""
        echo "=== Dependencies ==="
        readelf -d build/libluma_client.so | grep NEEDED
    
    - name: ðŸ—œï¸ Strip Binary
      run: |
        echo "Before: $(du -h build/libluma_client.so | cut -f1)"
        ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip build/libluma_client.so
        echo "After: $(du -h build/libluma_client.so | cut -f1)"
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: luma-client-x86_64
        path: build/libluma_client.so
        retention-days: 30
        if-no-files-found: error
    
    - name: ðŸ” Generate Checksum
      run: |
        cd build
        sha256sum libluma_client.so > libluma_client.so.sha256
        cat libluma_client.so.sha256
    
    - name: ðŸ“¤ Upload Checksum
      uses: actions/upload-artifact@v4
      with:
        name: luma-client-x86_64-checksum
        path: build/libluma_client.so.sha256

  build-arm64:
    name: Build ARM64
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: ðŸ”§ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential git
    
    - name: ðŸ“¦ Setup Android NDK r26b
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true
    
    - name: ðŸ’¾ Cache Dobby
      id: cache-dobby
      uses: actions/cache@v4
      with:
        path: /tmp/dobby-install
        key: dobby-arm64-r26b-v3
    
    - name: ðŸª Build Dobby for ARM64
      if: steps.cache-dobby.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 https://github.com/jmpews/Dobby.git /tmp/dobby-src
        mkdir -p /tmp/dobby-build
        cd /tmp/dobby-build
        
        # Configure for ARM64
        cmake /tmp/dobby-src \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/tmp/dobby-install \
          -DDOBBY_DEBUG=OFF \
          -DDOBBY_GENERATE_SHARED=ON
        
        ninja -j$(nproc)
        ninja install
    
    - name: âš™ï¸ Configure
      run: |
        mkdir -p build
        cd build
        
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_FIND_ROOT_PATH="/tmp/dobby-install" \
          -DCMAKE_PREFIX_PATH="/tmp/dobby-install"
    
    - name: ðŸ”¨ Build
      run: |
        cd build
        ninja -v -j$(nproc)
    
    - name: âœ… Verify
      run: |
        if [ ! -f "build/libluma_client.so" ]; then
          echo "âŒ ARM64 build failed"
          exit 1
        fi
        echo "âœ… ARM64 build successful"
        file build/libluma_client.so
    
    - name: ðŸ—œï¸ Strip
      run: |
        ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip build/libluma_client.so
    
    - name: ðŸ“¤ Upload
      uses: actions/upload-artifact@v4
      with:
        name: luma-client-arm64
        path: build/libluma_client.so
        retention-days: 30

  release:
    name: Create Release
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ“¥ Download x86_64
      uses: actions/download-artifact@v4
      with:
        name: luma-client-x86_64
        path: ./release
    
    - name: ðŸ“¥ Download ARM64
      uses: actions/download-artifact@v4
      with:
        name: luma-client-arm64
        path: ./release-arm64
    
    - name: ðŸ“¥ Download Checksum
      uses: actions/download-artifact@v4
      with:
        name: luma-client-x86_64-checksum
        path: ./release
    
    - name: ðŸ“¦ Prepare Release
      run: |
        cd release
        
        # Rename
        cp libluma_client.so luma-client-x86_64.so
        cp ../release-arm64/libluma_client.so luma-client-arm64.so
        
        # Checksums
        sha256sum luma-client-arm64.so > luma-client-arm64.so.sha256
        
        # Install guide
        cat > INSTALL.md << 'EOF'
        # Luma Client Installation
        
        ## For mcpelauncher (Linux x86_64)
        
        ```bash
        wget https://github.com/sheep1fy/Luma-Client/releases/latest/download/luma-client-x86_64.so
        mkdir -p ~/.local/share/mcpelauncher/mods
        mv luma-client-x86_64.so ~/.local/share/mcpelauncher/mods/libluma_client.so
        mcpelauncher-client
        ```
        
        Press **K** in-game to open the menu.
        
        ## For Android (ARM64)
        
        Download `luma-client-arm64.so` and place in your mods directory.
        
        ## Verify
        
        ```bash
        sha256sum -c luma-client-x86_64.so.sha256
        ```
        EOF
        
        ls -lh
    
    - name: ðŸš€ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/luma-client-x86_64.so
          release/luma-client-arm64.so
          release/libluma_client.so.sha256
          release/luma-client-arm64.so.sha256
          release/INSTALL.md
        body: |
          ## ðŸŽ® Luma Client ${{ github.ref_name }}
          
          ### ðŸ“¥ Quick Install (mcpelauncher)
          
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/luma-client-x86_64.so
          mv luma-client-x86_64.so ~/.local/share/mcpelauncher/mods/libluma_client.so
          ```
          
          ### âœ¨ Features
          
          - Modern glassmorphism UI with cyan accent
          - 14+ utility modules (ToggleSprint, Zoom, FPS, CPS, Coordinates, etc.)
          - Customizable HUD elements
          - Zero performance impact
          - Press **K** to open menu
          
          ### ðŸ” Verify Download
          
          ```bash
          sha256sum -c libluma_client.so.sha256
          ```
          
          ### ðŸ“‹ Included Files
          
          - `luma-client-x86_64.so` - For mcpelauncher on Linux
          - `luma-client-arm64.so` - For Android ARM64 devices
          - `*.sha256` - Checksums for verification
          - `INSTALL.md` - Detailed installation instructions
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
