name: Build Luma Client

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-x86_64:
    name: Build x86_64
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: ðŸ”§ Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          build-essential \
          git
    
    - name: ðŸ“¦ Setup Android NDK r26b
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true
    
    - name: ðŸ” Verify NDK Setup
      run: |
        echo "NDK Path: ${{ steps.setup-ndk.outputs.ndk-path }}"
        echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
        ls -la ${{ steps.setup-ndk.outputs.ndk-path }}
    
    - name: ðŸ’¾ Cache Dobby Build
      id: cache-dobby
      uses: actions/cache@v4
      with:
        path: |
          /tmp/dobby-install
          /tmp/dobby-src
        key: dobby-x86_64-r26b-${{ runner.os }}-v2
    
    - name: ðŸª Clone Dobby
      if: steps.cache-dobby.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 https://github.com/jmpews/Dobby.git /tmp/dobby-src
    
    - name: ðŸ”¨ Build Dobby
      if: steps.cache-dobby.outputs.cache-hit != 'true'
      run: |
        mkdir -p /tmp/dobby-build
        cd /tmp/dobby-build
        
        # Build Dobby with Android NDK
        cmake /tmp/dobby-src \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=x86_64 \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/tmp/dobby-install \
          -DDOBBY_DEBUG=OFF \
          -DDOBBY_GENERATE_SHARED=ON
        
        ninja
        ninja install
        
        # Verify installation
        echo "Dobby installation contents:"
        ls -la /tmp/dobby-install/
        find /tmp/dobby-install -name "*.so" -o -name "*.a"
    
    - name: ðŸ“‹ Verify Project Structure
      run: |
        echo "=== Project Root ==="
        ls -la
        
        echo ""
        echo "=== CMakeLists.txt Preview ==="
        head -30 CMakeLists.txt
        
        echo ""
        echo "=== ImGui Directory ==="
        ls -la imgui/
        
        echo ""
        echo "=== ImGui Backends ==="
        ls -la imgui/backends/
        
        echo ""
        echo "=== Source Files ==="
        ls -la src/
        
        echo ""
        echo "=== Include Files ==="
        ls -la include/
    
    - name: âš™ï¸ Configure CMake
      run: |
        mkdir -p build
        cd build
        
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=x86_64 \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_FIND_ROOT_PATH="/tmp/dobby-install;${{ steps.setup-ndk.outputs.ndk-path }}/sysroot" \
          -DCMAKE_PREFIX_PATH=/tmp/dobby-install \
          -DCMAKE_VERBOSE_MAKEFILE=ON \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
    
    - name: ðŸ” Debug CMake Configuration
      if: failure()
      run: |
        echo "=== CMake Cache ==="
        cat build/CMakeCache.txt || echo "CMakeCache.txt not found"
        
        echo ""
        echo "=== CMake Error Log ==="
        cat build/CMakeFiles/CMakeError.log || echo "No error log"
        
        echo ""
        echo "=== CMake Output Log ==="
        cat build/CMakeFiles/CMakeOutput.log || echo "No output log"
    
    - name: ðŸ”¨ Build with Ninja
      run: |
        cd build
        ninja -v
    
    - name: ðŸ” Debug Build Failure
      if: failure()
      run: |
        echo "=== Build Directory Contents ==="
        ls -la build/
        
        echo ""
        echo "=== Build Errors ==="
        cat build/CMakeFiles/luma_client.dir/build.log || echo "No build log"
        
        echo ""
        echo "=== Ninja Build Log ==="
        cat build/.ninja_log || echo "No ninja log"
    
    - name: âœ… Verify Build Output
      run: |
        if [ ! -f "build/libluma_client.so" ]; then
          echo "âŒ ERROR: libluma_client.so not found!"
          echo ""
          echo "Build directory contents:"
          find build -type f
          exit 1
        fi
        
        echo "âœ… Build successful!"
        echo ""
        echo "File: build/libluma_client.so"
        echo "Size: $(du -h build/libluma_client.so | cut -f1)"
        echo ""
        
        echo "=== File Type ==="
        file build/libluma_client.so
        
        echo ""
        echo "=== Exported Symbols ==="
        nm -D build/libluma_client.so | grep -E "init_luma|toggle_luma|run_luma" || echo "Warning: Expected symbols not found"
        
        echo ""
        echo "=== Dependencies ==="
        readelf -d build/libluma_client.so | grep NEEDED || true
        
        echo ""
        echo "=== ELF Header ==="
        readelf -h build/libluma_client.so
    
    - name: ðŸ—œï¸ Strip Debug Symbols
      run: |
        echo "Original size: $(du -h build/libluma_client.so | cut -f1)"
        ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip build/libluma_client.so
        echo "Stripped size: $(du -h build/libluma_client.so | cut -f1)"
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: luma-client-x86_64
        path: build/libluma_client.so
        retention-days: 30
        if-no-files-found: error
    
    - name: ðŸ” Generate Checksum
      run: |
        cd build
        sha256sum libluma_client.so > libluma_client.so.sha256
        echo "SHA256:"
        cat libluma_client.so.sha256
    
    - name: ðŸ“¤ Upload Checksum
      uses: actions/upload-artifact@v4
      with:
        name: luma-client-x86_64-checksum
        path: build/libluma_client.so.sha256

  build-arm64:
    name: Build ARM64
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: ðŸ”§ Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential git
    
    - name: ðŸ“¦ Setup Android NDK r26b
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true
    
    - name: ðŸ’¾ Cache Dobby Build
      id: cache-dobby
      uses: actions/cache@v4
      with:
        path: |
          /tmp/dobby-install
          /tmp/dobby-src
        key: dobby-arm64-r26b-${{ runner.os }}-v2
    
    - name: ðŸª Clone Dobby
      if: steps.cache-dobby.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 https://github.com/jmpews/Dobby.git /tmp/dobby-src
    
    - name: ðŸ”¨ Build Dobby
      if: steps.cache-dobby.outputs.cache-hit != 'true'
      run: |
        mkdir -p /tmp/dobby-build
        cd /tmp/dobby-build
        
        cmake /tmp/dobby-src \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/tmp/dobby-install \
          -DDOBBY_DEBUG=OFF \
          -DDOBBY_GENERATE_SHARED=ON
        
        ninja
        ninja install
    
    - name: âš™ï¸ Configure CMake
      run: |
        mkdir -p build
        cd build
        
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_FIND_ROOT_PATH="/tmp/dobby-install;${{ steps.setup-ndk.outputs.ndk-path }}/sysroot" \
          -DCMAKE_PREFIX_PATH=/tmp/dobby-install
    
    - name: ðŸ”¨ Build
      run: |
        cd build
        ninja -v
    
    - name: âœ… Verify Build
      run: |
        if [ ! -f "build/libluma_client.so" ]; then
          echo "âŒ ARM64 build failed"
          exit 1
        fi
        echo "âœ… ARM64 build successful"
        file build/libluma_client.so
    
    - name: ðŸ—œï¸ Strip
      run: |
        ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip build/libluma_client.so
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: luma-client-arm64
        path: build/libluma_client.so
        retention-days: 30

  create-release:
    name: Create Release
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ“¥ Download x86_64
      uses: actions/download-artifact@v4
      with:
        name: luma-client-x86_64
        path: ./release
    
    - name: ðŸ“¥ Download ARM64
      uses: actions/download-artifact@v4
      with:
        name: luma-client-arm64
        path: ./release
    
    - name: ðŸ“¥ Download Checksum
      uses: actions/download-artifact@v4
      with:
        name: luma-client-x86_64-checksum
        path: ./release
    
    - name: ðŸ“¦ Prepare Release
      run: |
        cd release
        
        # Rename files
        cp libluma_client.so luma-client-x86_64.so
        
        # Create installation guide
        cat > INSTALL.md << 'EOF'
        # Luma Client Installation
        
        ## For mcpelauncher (Linux)
        
        ```bash
        # Download
        wget https://github.com/sheep1fy/Luma-Client/releases/latest/download/luma-client-x86_64.so
        
        # Install
        mkdir -p ~/.local/share/mcpelauncher/mods
        mv luma-client-x86_64.so ~/.local/share/mcpelauncher/mods/libluma_client.so
        
        # Launch game
        mcpelauncher-client
        ```
        
        Press 'K' in-game to open the menu.
        
        ## Verify Download
        
        ```bash
        sha256sum -c libluma_client.so.sha256
        ```
        EOF
        
        ls -lh
    
    - name: ðŸš€ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/luma-client-x86_64.so
          release/libluma_client.so.sha256
          release/INSTALL.md
        body: |
          ## Luma Client ${{ github.ref_name }}
          
          ### Quick Install (mcpelauncher)
          
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/luma-client-x86_64.so
          mv luma-client-x86_64.so ~/.local/share/mcpelauncher/mods/libluma_client.so
          ```
          
          ### Features
          - Modern glassmorphism UI
          - 14+ modules (ToggleSprint, Zoom, FPS, CPS, etc.)
          - Custom HUD elements
          - Press 'K' to open menu
          
          ### Verify
          ```bash
          sha256sum -c libluma_client.so.sha256
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
