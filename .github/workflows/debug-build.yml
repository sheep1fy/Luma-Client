name: Debug Build

on:
  workflow_dispatch:
  push:
    branches: [ debug, test ]

jobs:
  diagnose:
    name: Diagnose Build Issues
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential tree
    
    - name: ðŸ“¦ Setup NDK
      uses: nttld/setup-ndk@v1
      id: ndk
      with:
        ndk-version: r26b
    
    - name: ðŸ” System Information
      run: |
        echo "=== OS Info ==="
        uname -a
        lsb_release -a
        
        echo ""
        echo "=== CMake Version ==="
        cmake --version
        
        echo ""
        echo "=== Ninja Version ==="
        ninja --version
        
        echo ""
        echo "=== GCC Version ==="
        gcc --version
        
        echo ""
        echo "=== NDK Info ==="
        echo "NDK Path: ${{ steps.ndk.outputs.ndk-path }}"
        ls -la ${{ steps.ndk.outputs.ndk-path }}
    
    - name: ðŸ“‹ Check Project Files
      run: |
        echo "=== Project Tree ==="
        tree -L 3 -I 'build|.git'
        
        echo ""
        echo "=== CMakeLists.txt ==="
        cat CMakeLists.txt
        
        echo ""
        echo "=== Check for imgui files ==="
        ls -la imgui/ || echo "imgui/ directory not found!"
        ls -la imgui/backends/ || echo "imgui/backends/ not found!"
        
        echo ""
        echo "=== Check source files ==="
        ls -la src/
        ls -la src/modules/
        
        echo ""
        echo "=== Check include files ==="
        ls -la include/
    
    - name: ðŸ§ª Test Simple CMake
      run: |
        mkdir -p test-build
        cd test-build
        
        # Test basic NDK CMake
        cat > CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.10)
        project(test)
        set(CMAKE_CXX_STANDARD 17)
        
        message(STATUS "NDK Path: ${ANDROID_NDK}")
        message(STATUS "ABI: ${ANDROID_ABI}")
        message(STATUS "Platform: ${ANDROID_PLATFORM}")
        message(STATUS "Compiler: ${CMAKE_CXX_COMPILER}")
        
        add_library(test SHARED test.cpp)
        target_link_libraries(test log)
        EOF
        
        cat > test.cpp << 'EOF'
        #include <android/log.h>
        #define LOG_TAG "TEST"
        #define LOGI(...) __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)
        
        extern "C" void test_init() {
            LOGI("Test library loaded");
        }
        EOF
        
        cmake . \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=x86_64 \
          -DANDROID_PLATFORM=android-24
        
        ninja -v
        
        if [ -f "libtest.so" ]; then
          echo "âœ… Basic NDK build works!"
          file libtest.so
        else
          echo "âŒ Basic NDK build failed"
          exit 1
        fi
    
    - name: ðŸª Test Dobby Build
      run: |
        git clone --depth 1 https://github.com/jmpews/Dobby.git /tmp/dobby
        mkdir -p /tmp/dobby-build
        cd /tmp/dobby-build
        
        echo "=== Configuring Dobby ==="
        cmake /tmp/dobby \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=x86_64 \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DDOBBY_DEBUG=OFF
        
        echo ""
        echo "=== Building Dobby ==="
        ninja -v
        
        echo ""
        echo "=== Dobby Build Output ==="
        ls -la
        find . -name "*.so" -o -name "*.a"
    
    - name: ðŸ§ª Test ImGui Compilation
      run: |
        if [ ! -f "imgui/imgui.cpp" ]; then
          echo "âŒ imgui.cpp not found! Creating stub..."
          mkdir -p imgui/backends
          
          # This should fail if imgui files are missing
          echo "ImGui files are required but missing from repository"
          exit 1
        fi
        
        echo "âœ… ImGui files found"
        ls -la imgui/
    
    - name: ðŸ“ Generate Diagnostics Report
      if: always()
      run: |
        cat > diagnostics.md << 'EOF'
        # Build Diagnostics Report
        
        ## Environment
        - OS: Ubuntu (GitHub Actions)
        - CMake: $(cmake --version | head -1)
        - NDK: r26b
        
        ## Files Checked
        - [ ] CMakeLists.txt exists
        - [ ] imgui/ directory exists
        - [ ] imgui/backends/ exists
        - [ ] src/ directory exists
        - [ ] include/ directory exists
        
        ## Build Tests
        - [ ] Basic NDK build works
        - [ ] Dobby builds successfully
        - [ ] ImGui files present
        
        ## Next Steps
        Check the workflow logs above for specific failures.
        EOF
        
        cat diagnostics.md
    
    - name: ðŸ“¤ Upload Diagnostics
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: diagnostics
        path: diagnostics.md
